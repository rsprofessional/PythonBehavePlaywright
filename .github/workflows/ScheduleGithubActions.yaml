name: Scheduled Behave Tests - Chromium

run-name: Scheduled Behave Run - Chromium ðŸ•’

on:
  schedule:
    - cron: '0 19 * * 1' # toas as segundas feiras as 19h UTC #
  workflow_dispatch:
    inputs:
      tags:
        description: 'Tags do Behave'
        required: false
        default: '@smoke'
jobs:
  tests:
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
      # 1. Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2. Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      # 3. Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Instalar dependÃªncias
      - name: Install Requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          npm install -g allure-commandline
          playwright install --with-deps

      # 5. Add npm global bin to PATH
      - name: Add npm global bin to PATH
        run: echo "$(npm bin -g)" >> $GITHUB_PATH

      # 6. Run Behave Tests
      - name: Run Behave Tests
        working-directory: PyPwBehave/test-automation-tool
        env:
          ALLURE_RESULTS_DIR: allure-results/chromium
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          mkdir -p "$ALLURE_RESULTS_DIR"

          # Allure Environment
          ENV_FILE="$ALLURE_RESULTS_DIR/environment.properties"
          EXEC_FILE="$ALLURE_RESULTS_DIR/executor.json"

          echo "Browser=chromium"     >  "$ENV_FILE"
          echo "Execution=Schedule"  >> "$ENV_FILE"
          echo "OS=Linux"            >> "$ENV_FILE"

          cat <<EOF > "$EXEC_FILE"
          {
            "name": "GitHub Actions Scheduler",
            "type": "ci",
            "buildName": "Scheduled Behave - Chromium",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF

          export PW_BROWSER=chromium

          behave src/features \
            --no-capture \
            -f allure_behave.formatter:AllureFormatter \
            -o "$ALLURE_RESULTS_DIR" \
            -D browser=chromium \
            --tags ${{ github.event.inputs.tags || '@smoke' }}

      # 7. Generate Allure Report
      - name: Generate Allure Report
        if: always()
        working-directory: PyPwBehave/test-automation-tool
        run: |
          allure generate "allure-results/chromium" -o "allure-report/chromium" --clean

      # 8. Zip Allure Report
      - name: Zip Allure Report
        if: always()
        working-directory: PyPwBehave/test-automation-tool
        run: |
          zip -r "allure-report-chromium.zip" "allure-report/chromium" "allure-results/chromium"

      # 9. Upload Allure Report
      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-chromium
          path: PyPwBehave/test-automation-tool/allure-report-chromium.zip
          retention-days: 5
