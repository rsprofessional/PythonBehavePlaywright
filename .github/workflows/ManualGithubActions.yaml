name: Manual GitHub Actions Demo Tests - Behave +Playwright

permissions:
  contents: write
  pages: write

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Qual a tag?
        required: true
        type: choice
        options:
          - login
          - smoke
          - regression

jobs:

  tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
      fail-fast: false

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps
          npm install -g allure-commandline

      - name: Run tests
        working-directory: PyPwBehave/test-automation-tool
        run: |
          mkdir -p allure-results/${{ matrix.browser }}
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          behave src/features/Development_python.feature \
            --no-capture \
            -D browser=${{ matrix.browser }} \
            -t @${{ inputs.tag }}

      - name: Generate Allure Report
        working-directory: PyPwBehave/test-automation-tool
        run: |
          allure generate allure-results/${{ matrix.browser }} \
            -o allure-report/${{ matrix.browser }} --clean

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-${{ matrix.browser }}
          path: PyPwBehave/test-automation-tool/allure-report/${{ matrix.browser }}

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    if: always()

    steps:
      - uses: actions/checkout@v3

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Build Pages structure
        run: |
          mkdir -p public
          mv reports/allure-chromium public/chromium
          mv reports/allure-firefox public/firefox
          mv reports/allure-webkit public/webkit

      - name: Create index.html
        run: |
          cat <<EOF > public/index.html
          <!DOCTYPE html>
          <html lang="pt-br">
          <head>
            <meta charset="UTF-8">
            <title>Allure Reports</title>
          </head>
          <body>
            <h1>Allure Reports</h1>
            <ul>
              <li><a href="./chromium/">Chromium</a></li>
              <li><a href="./firefox/">Firefox</a></li>
              <li><a href="./webkit/">WebKit</a></li>
            </ul>
          </body>
          </html>
          EOF

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: public
          publish_branch: gh-pages
