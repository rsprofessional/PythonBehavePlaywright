name: GitHub Actions Demo Tests - Behave + Allure
run-name: ${{ github.actor }} is testing Behave + Playwright üöÄ

on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Escolha o browser'
        required: true
        default: all
        type: choice
        options: [all, chromium, firefox, webkit, edge]
      tags:
        description: 'Tags do Behave'
        required: true
        default: all
        type: choice
        options: [all, smoke, feature, regression, api]

jobs:
  tests:
    runs-on: ubuntu-latest
    permissions: write-all

    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(
          github.event.inputs.browser == 'all'
          && '["chromium","firefox","webkit","edge"]'
          || format('["{0}"]', github.event.inputs.browser)
         ) }}

    steps:
      # 1Ô∏è‚É£ Checkout main branch
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Checkout gh-pages (somente para hist√≥rico)
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      # 3Ô∏è‚É£ Setup Python
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: pip

      # 4Ô∏è‚É£ Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 5Ô∏è‚É£ Install Dependencies
      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          npm install -g allure-commandline
          playwright install --with-deps

      # 6Ô∏è‚É£ Run Behave Tests + History Restore
      - name: Run Behave Tests
        working-directory: PyPwBehave/test-automation-tool
        env:
          ALLURE_RESULTS_DIR: allure-results/${{ matrix.browser }}
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          mkdir -p "$ALLURE_RESULTS_DIR"

          # Write Environment Properties
          echo "Browser=${{ matrix.browser }}" > "$ALLURE_RESULTS_DIR/environment.properties"
          echo "Execution=CI" >> "$ALLURE_RESULTS_DIR/environment.properties"
          echo "Release=release 1.1" >> "$ALLURE_RESULTS_DIR/environment.properties"
          echo "OS=Linux" >> "$ALLURE_RESULTS_DIR/environment.properties"

          # Write Executor JSON
          cat <<EOF > "$ALLURE_RESULTS_DIR/executor.json"
          {
            "name": "GitHub Actions",
            "type": "ci",
            "buildName": "Behave Run - ${{ matrix.browser }}",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF

          # Restore Allure History (se existir)
          HISTORY_SRC="gh-pages/${{ matrix.browser }}/history"
          if [ -d "$HISTORY_SRC" ]; then
            mkdir -p "$ALLURE_RESULTS_DIR/history"
            cp -r "$HISTORY_SRC/"* "$ALLURE_RESULTS_DIR/history/"
          fi

          # Determine Browser
          [ "${{ matrix.browser }}" = "edge" ] && PW_BROWSER=chromium || PW_BROWSER=${{ matrix.browser }}

          # Determine Tags
          [ "${{ github.event.inputs.tags }}" != "all" ] && TAGS="--tags @${{ github.event.inputs.tags }}" || TAGS=""

          # Run Behave
          behave src/features \
            -f allure_behave.formatter:AllureFormatter \
            -o "$ALLURE_RESULTS_DIR" \
            -D browser=$PW_BROWSER \
            $TAGS

      # 7Ô∏è‚É£ Debug: listar arquivos gerados no allure-results
      - name:
        Debug: List Allure Results
        working-directory: PyPwBehave/test-automation-tool
        run: |
          echo "Conte√∫do de $ALLURE_RESULTS_DIR:"
          ls -l "$ALLURE_RESULTS_DIR"

      # 8Ô∏è‚É£ Generate Allure Report (LOCAL)
      - name: Generate Allure Report
        working-directory: PyPwBehave/test-automation-tool
        run: |
          allure generate "$ALLURE_RESULTS_DIR" -o "allure-report/${{ matrix.browser }}" --clean

      # 9Ô∏è‚É£ Upload Artifact ZIP
      - uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.browser }}
          path: PyPwBehave/test-automation-tool/allure-report/${{ matrix.browser }}
          retention-days: 5

      # üîü Publish to GitHub Pages
      - name: Publish to GitHub Pages
        run: |
          # Remove old report do browser
          rm -rf gh-pages/${{ matrix.browser }}
          mkdir -p gh-pages/${{ matrix.browser }}

          # Copy local report para gh-pages
          cp -r PyPwBehave/test-automation-tool/allure-report/${{ matrix.browser}}/. \
             gh-pages/${{ matrix.browser}}

          cd gh-pages
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Allure report (${{ matrix.browser }}) - run ${{ github.run_number }}" || true
          git push
