name: GitHub Actions Demo Tests - Behave + Allure
run-name: ${{ github.actor }} is testing Behave + Playwright ðŸš€

on:
  workflow_dispatch:
    inputs:
      browser:
        description: 'Escolha o browser'
        required: true
        default: all
        type: choice
        options: [all, chromium, firefox, webkit, edge]
      tags:
        description: 'Tags do Behave'
        required: true
        default: all
        type: choice
        options: [all, smoke, feature, regression, api]

jobs:
  tests:
    runs-on: ubuntu-latest
    permissions: write-all

    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(
          github.event.inputs.browser == 'all'
          && '["chromium","firefox","webkit","edge"]'
          || format('["{0}"]', github.event.inputs.browser)
         ) }}

    steps:
      # Checkout main
      - uses: actions/checkout@v4

      # Checkout gh-pages (para history)
      - uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      # Python
      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: pip

      # Node
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Dependencies
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          npm install -g allure-commandline
          playwright install --with-deps

      # Run Tests
      - name: Run Behave Tests
        working-directory: PyPwBehave/test-automation-tool
        env:
          ALLURE_RESULTS_DIR: allure-results/${{ matrix.browser }}
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)/src
          mkdir -p "$ALLURE_RESULTS_DIR"

          # Environment
          echo "Browser=${{ matrix.browser }}" >  "$ALLURE_RESULTS_DIR/environment.properties"
          echo "Execution=CI"               >> "$ALLURE_RESULTS_DIR/environment.properties"
          echo "Release=release 1.1"        >> "$ALLURE_RESULTS_DIR/environment.properties"
          echo "OS=Linux"                   >> "$ALLURE_RESULTS_DIR/environment.properties"

          # Executor
          cat <<EOF > "$ALLURE_RESULTS_DIR/executor.json"
          {
            "name": "GitHub Actions",
            "type": "ci",
            "buildName": "Behave Run - ${{ matrix.browser }}",
            "buildUrl": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          EOF

          # Restore history
          if [ -d "../../gh-pages/${{ matrix.browser }}/history" ]; then
            mkdir -p "$ALLURE_RESULTS_DIR/history"
            cp -r "../../gh-pages/${{ matrix.browser }}/history/"* "$ALLURE_RESULTS_DIR/history/"
          fi

          # Browser
          [ "${{ matrix.browser }}" = "edge" ] && PW_BROWSER=chromium || PW_BROWSER=${{ matrix.browser }}

          # Tags
          [ "${{ github.event.inputs.tags }}" != "all" ] && TAGS="--tags @${{ github.event.inputs.tags }}" || TAGS=""

          behave src/features \
            -f allure_behave.formatter:AllureFormatter \
            -o "$ALLURE_RESULTS_DIR" \
            -D browser=$PW_BROWSER \
            $TAGS

      # Generate Allure Report (LOCAL)
      - name: Generate Allure Report
        working-directory: PyPwBehave/test-automation-tool
        run: |
          allure generate "$ALLURE_RESULTS_DIR" \
            -o "allure-report/${{ matrix.browser }}" --clean

      # Upload Artifact (ZIP)
      - uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ matrix.browser }}
          path: PyPwBehave/test-automation-tool/allure-report/${{ matrix.browser }}
          retention-days: 5

      # Copy to GitHub Pages
      - name: Publish to GitHub Pages
        run: |
          rm -rf gh-pages/${{ matrix.browser }}
          cp -r PyPwBehave/test-automation-tool/allure-report/${{ matrix.browser }} gh-pages/${{ matrix.browser }}

          cd gh-pages
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Allure report (${{ matrix.browser }}) - run ${{ github.run_number }}" || true
          git push
